machine:
  services:
    - docker

dependencies:
  override:
    - docker info
    # login so we can access private repo
    - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS
    # pull image from registry to cache docker layers for quicker rebuilds
    - docker pull ctippett/ticket-bounty-movie-api:latest
    # build new image
    - docker build -t ticket-bounty-movie-api .

test:
  override:
    - docker run ticket-bounty-movie-api test
    - docker run -d -p 5000:5000 ticket-bounty-movie-api # launch app in detached mode
    - curl --retry 10 --retry-delay 5 -v http://localhost:5000 # test app is running on port 5000

deployment:
  dockerhub:
    branch: master
    commands:
      # Push the same image twice, once with the commit hash as the tag, and once with
      # 'latest' as the tag. 'latest' will always refer to the last image that was
      # built, since the next time this script is run, it'll get overridden. The
      # commit hash, however, is a constant reference to this image.
      - docker tag -f ticket-bounty-movie-api ctippett/ticket-bounty-movie-api:$CIRCLE_SHA1
      - docker push ctippett/ticket-bounty-movie-api:$CIRCLE_SHA1
      - docker tag -f ticket-bounty-movie-api ctippett/ticket-bounty-movie-api:latest
      - docker push ctippett/ticket-bounty-movie-api:latest